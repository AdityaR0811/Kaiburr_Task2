name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Start MongoDB
        run: |
          docker run -d \
            --name mongo-test \
            -p 27017:27017 \
            mongo:5.0
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Run unit tests
        run: mvn test
      
      - name: Set up kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: kaiburr-ci
          version: v0.20.0
      
      - name: Verify kind cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Build executor image
        run: |
          cd executor
          docker build -t kaiburr-executor:ci .
          cd ..
      
      - name: Load executor image into kind
        run: |
          kind load docker-image kaiburr-executor:ci --name kaiburr-ci
      
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f deploy/k8s/
          kubectl wait --for=condition=ready --timeout=60s \
            -n kaiburr serviceaccount/kaiburr-runner
      
      - name: Run integration tests
        env:
          SPRING_PROFILES_ACTIVE: k8s
          MONGODB_URI: mongodb://localhost:27017/kaiburrdb
          K8S_NAMESPACE: kaiburr
          K8S_EXECUTOR_IMAGE: kaiburr-executor:ci
        run: |
          mvn verify -Pintegration-test
      
      - name: Generate coverage report
        run: mvn jacoco:report
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
      
      - name: Check Kubernetes resources
        if: always()
        run: |
          kubectl get all -n kaiburr
          kubectl logs -n kaiburr -l app=kaiburr-exec --tail=50 || true
